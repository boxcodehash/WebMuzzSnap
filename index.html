<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MuzzSnap</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; overflow-x: hidden; background-color: #0a0a0a; }
        .muzz-background {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: radial-gradient(circle at 10% 50%, rgba(100, 100, 100, 0.08) 0%, transparent 50%),
                        radial-gradient(circle at 90% 80%, rgba(50, 50, 50, 0.1) 0%, transparent 60%);
        }
        #logoButton { cursor: pointer; transition: all 0.3s ease; }
        #logoButton:hover { opacity: 0.9; transform: scale(1.02); }
    </style>
</head>
<body class="p-4 text-white">
    <div class="muzz-background"></div>

    <div id="statusContainer" class="absolute top-4 right-4 z-20 flex flex-col items-end gap-2">
        <span id="walletStatus" class="py-2 px-4 text-xs font-medium text-gray-400 bg-gray-800 rounded-lg border border-gray-700">
            Disconnected
        </span>
    </div>

    <div class="relative z-10 flex flex-col items-center justify-center min-h-[80vh] max-w-sm mx-auto text-center">
        
        <div id="logoButton" onclick="handleLogin()" class="mb-6 relative group">
            <img id="muzzLogo" src="https://img1.wsimg.com/isteam/ip/ac9578cb-a6ce-417e-8ad5-b2d6701462eb/1000030902.png/:/rs=w:1440,h:1440" 
                 alt="MuzzSnap" class="w-40 h-40 rounded-2xl shadow-2xl group-hover:rotate-2 transition duration-500">
            
            <div id="loadingSpinner" class="hidden absolute inset-0 flex items-center justify-center bg-black/40 rounded-2xl backdrop-blur-sm">
                <i class="fas fa-spinner fa-spin text-4xl text-white"></i>
            </div>
        </div>

        <h1 class="text-4xl font-black mb-2 tracking-tight"></h1>
        <p class="text-xs text-gray-500 mb-8 tracking-widest uppercase">
            Secure Decentralized Chat
        </p>

        <div id="messageArea" class="hidden w-full mb-8 p-4 bg-gray-900/80 border border-gray-800 rounded-xl backdrop-blur-md">
            <p id="messageTitle" class="text-sm font-bold text-red-400 mb-1">Error</p>
            <p id="messageText" class="text-xs text-gray-400">Description</p>
        </div>

        <p class="text-xs text-gray-600 animate-pulse mt-4">
            Click the logo to connect wallet
        </p>

        <footer class="mt-16 text-[10px] text-gray-700 font-mono">
            MuzzSnap 2025&trade; &bull; By.Ryachu
        </footer>
    </div>

    <script>
        const CONTRACT_ADDRESS = "0xef3dAa5fDa8Ad7aabFF4658f1F78061fd626B8f0";
        const MIN_REQUIRED_TOKENS = 40000000; // 40 Millones
        const LOGIN_MESSAGE = `Welcome to MuzzSnap\n\nLogin Request:\n${new Date().toISOString().split('T')[0]}\n\nSign to authenticate.`;

        // ABI Mínimo para consultar balance y decimales
        const ERC20_ABI = [
            "function balanceOf(address owner) view returns (uint256)",
            "function decimals() view returns (uint8)"
        ];

        const ui = {
            logo: document.getElementById('muzzLogo'),
            spinner: document.getElementById('loadingSpinner'),
            status: document.getElementById('walletStatus'),
            msgArea: document.getElementById('messageArea'),
            msgTitle: document.getElementById('messageTitle'),
            msgText: document.getElementById('messageText')
        };

        function setStatus(text, color = 'gray') {
            ui.status.textContent = text;
            ui.status.className = `py-2 px-4 text-xs font-medium rounded-lg border bg-gray-900 border-${color}-700 text-${color}-400`;
        }

        function showMessage(title, text, isError = true) {
            ui.msgArea.classList.remove('hidden');
            ui.msgTitle.textContent = title;
            ui.msgTitle.className = `text-sm font-bold mb-1 ${isError ? 'text-red-400' : 'text-green-400'}`;
            ui.msgText.textContent = text;
        }

        async function handleLogin() {
            if (typeof window.ethereum === 'undefined') {
                showMessage("MetaMask Missing", "Please install MetaMask.");
                if (/Android|iPhone|iPad/i.test(navigator.userAgent)) {
                    window.location.href = `https://metamask.app.link/dapp/${window.location.host}${window.location.pathname}`;
                }
                return;
            }

            ui.spinner.classList.remove('hidden');
            ui.msgArea.classList.add('hidden');
            setStatus('Connecting...', 'yellow');

            try {
                // 1. Connect Wallet
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                const accounts = await provider.send("eth_requestAccounts", []);
                const address = accounts[0];

                // 2. CHECK BALANCE (Lógica Nueva)
                setStatus('Checking Balance...', 'blue');
                
                const contract = new ethers.Contract(CONTRACT_ADDRESS, ERC20_ABI, provider);
                
                // Obtenemos decimales dinámicamente para ser precisos
                const decimals = await contract.decimals();
                const balanceBN = await contract.balanceOf(address);
                const balanceFormatted = ethers.utils.formatUnits(balanceBN, decimals);
                
                console.log(`User Balance: ${balanceFormatted}`);

                if (parseFloat(balanceFormatted) < MIN_REQUIRED_TOKENS) {
                    throw new Error("need Minimum 40M Muzz");
                }
                
                // 3. Sign Message (Solo si tiene balance)
                setStatus('Waiting for signature...', 'yellow');
                const signer = provider.getSigner();
                await signer.signMessage(LOGIN_MESSAGE);

                // 4. Success
                setStatus('Success!', 'green');
                showMessage("Authenticated", "Redirecting...", false);
                
                sessionStorage.setItem('muzz_auth_pending', 'true');
                
                setTimeout(() => {
                    window.location.href = 'chat.html';
                }, 1000);

            } catch (error) {
                console.error(error);
                setStatus('Access Denied', 'red');
                
                // Si el error es nuestro mensaje personalizado, lo mostramos limpio
                if (error.message.includes("need Minimum 40M Muzz")) {
                    showMessage("Access Denied", "need Minimum 40M Muzz");
                } else {
                    showMessage("Error", error.message || "Connection failed");
                }
            } finally {
                ui.spinner.classList.add('hidden');
            }
        }
    </script>
</body>
</html>
