<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MuzzSnap | Protocol</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js" type="text/javascript"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&display=swap');
        body { background-color: #050505; color: white; font-family: sans-serif; height: 100vh; display: flex; align-items: center; justify-content: center; margin: 0; }
        .logo-glow { box-shadow: 0 0 40px rgba(255, 0, 0, 0.2); border: 1px solid rgba(255, 255, 255, 0.1); transition: 0.3s; cursor: pointer; }
        .logo-glow:active { transform: scale(0.95); }
        .loading-spinner { animation: spin 1s linear infinite; border: 3px solid transparent; border-top-color: #ff0000; border-radius: 50%; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="text-center px-6 w-full max-w-sm">
        <div id="btnConnect" class="relative inline-block mb-6">
            <div id="loadingUI" class="hidden absolute inset-0 z-20 flex items-center justify-center bg-black/50 rounded-3xl">
                <div class="loading-spinner w-12 h-12"></div>
            </div>
            <img src="https://img1.wsimg.com/isteam/ip/ac9578cb-a6ce-417e-8ad5-b2d6701462eb/1000030902.png/:/rs=w:1440,h:1440" 
                 class="logo-glow w-32 h-32 md:w-40 md:h-40 rounded-3xl">
        </div>

        <h1 style="font-family: 'Orbitron';" class="text-2xl font-black tracking-tighter italic mb-1">
            MUZZ<span class="text-red-600">SNAP</span>
        </h1>
        <p id="statusText" class="text-[10px] text-gray-500 uppercase tracking-[0.3em] mb-8">Tap logo to enter</p>

        <div id="errorBox" class="hidden p-3 rounded-lg bg-red-900/20 border border-red-500/50 mb-6">
            <p id="errorTitle" class="text-red-500 text-[10px] font-bold uppercase mb-1"></p>
            <p id="errorDesc" class="text-gray-400 text-[10px] leading-tight"></p>
        </div>

        <div class="text-[9px] text-gray-700 font-mono uppercase tracking-widest">
            &copy; 2025 Protocol Ryachu Edition
        </div>
    </div>

    <script>
        // Configuración
        const MIN_TOKENS = 20000000;
        const TOKEN_ADDR = "0xef3dAa5fDa8Ad7aabFF4658f1F78061fd626B8f0";
        
        const uiBtn = document.getElementById('btnConnect');
        const uiLoading = document.getElementById('loadingUI');
        const uiStatus = document.getElementById('statusText');
        const uiError = document.getElementById('errorBox');
        const uiErrTitle = document.getElementById('errorTitle');
        const uiErrDesc = document.getElementById('errorDesc');

        async function handleLogin() {
            // Reset UI
            uiError.classList.add('hidden');
            uiLoading.classList.remove('hidden');
            uiStatus.innerText = "Initializing...";

            // 1. Verificar si hay Wallet
            if (typeof window.ethereum === 'undefined') {
                if (/Android|iPhone|iPad/i.test(navigator.userAgent)) {
                    const link = "https://metamask.app.link/dapp/" + window.location.host + window.location.pathname;
                    window.location.href = link;
                } else {
                    showError("No Wallet", "Please install MetaMask extension.");
                }
                return;
            }

            try {
                // Usar ethers
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                
                // 2. Pedir Cuenta
                uiStatus.innerText = "Connecting Wallet...";
                const accounts = await provider.send("eth_requestAccounts", []);
                const wallet = accounts[0];

                // 3. Firma de Seguridad
                uiStatus.innerText = "Signature Required...";
                const msg = `MuzzSnap Login\n\nNode: ${wallet}\nAccess: 20M MUZZLE required.`;
                const sig = await provider.getSigner().signMessage(msg);

                // 4. Verificar Balance
                uiStatus.innerText = "Checking Balance...";
                const abi = ["function balanceOf(address owner) view returns (uint256)"];
                const contract = new ethers.Contract(TOKEN_ADDR, abi, provider);
                const rawBalance = await contract.balanceOf(wallet);
                const balance = parseFloat(ethers.utils.formatUnits(rawBalance, 18));

                if (balance < MIN_TOKENS) {
                    showError("Access Denied", `20M MUZZLE required. You have: ${Math.floor(balance).toLocaleString()}`);
                    return;
                }

                // 5. Éxito
                uiStatus.innerText = "Access Granted!";
                sessionStorage.setItem('muzz_wallet_address', wallet.toLowerCase());
                
                setTimeout(() => {
                    window.location.href = 'chat.html';
                }, 800);

            } catch (err) {
                console.error(err);
                uiLoading.classList.add('hidden');
                uiStatus.innerText = "Failed";
                showError("System Error", err.message || "User rejected connection.");
            }
        }

        function showError(title, desc) {
            uiLoading.classList.add('hidden');
            uiError.classList.remove('hidden');
            uiErrTitle.innerText = title;
            uiErrDesc.innerText = desc;
        }

        uiBtn.onclick = handleLogin;
    </script>
</body>
</html>
