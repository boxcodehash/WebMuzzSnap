<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MuzzSnap | Secure Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; overflow-x: hidden; background-color: #0a0a0a; color: white; }
        .muzz-background {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: radial-gradient(circle at 50% 50%, rgba(220, 38, 38, 0.05) 0%, transparent 100%);
        }
        #logoButton { cursor: pointer; transition: all 0.3s ease; -webkit-tap-highlight-color: transparent; }
        #logoButton:active { transform: scale(0.95); }
        .pulse-red { animation: pulse-red 2s infinite; }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); }
            70% { box-shadow: 0 0 0 20px rgba(220, 38, 38, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
        }
    </style>
</head>
<body class="p-4">
    <div class="muzz-background"></div>

    <div id="statusContainer" class="absolute top-4 right-4 z-20">
        <span id="walletStatus" class="py-2 px-4 text-[10px] font-bold uppercase tracking-widest text-gray-500 bg-gray-900/80 rounded-full border border-gray-800">
            <i class="fas fa-circle mr-2"></i> Disconnected
        </span>
    </div>

    <div class="relative z-10 flex flex-col items-center justify-center min-h-[90vh] max-w-sm mx-auto text-center">
        
        <div id="logoButton" class="mb-8 relative group pulse-red rounded-2xl">
            <img id="muzzLogo" src="https://img1.wsimg.com/isteam/ip/ac9578cb-a6ce-417e-8ad5-b2d6701462eb/1000030902.png/:/rs=w:1440,h:1440" 
                 alt="MuzzSnap" class="w-32 h-32 md:w-40 md:h-40 rounded-2xl shadow-2xl border border-white/10">
            
            <div id="loadingSpinner" class="hidden absolute inset-0 flex items-center justify-center bg-black/70 rounded-2xl backdrop-blur-sm">
                <i class="fas fa-circle-notch fa-spin text-4xl text-red-600"></i>
            </div>
        </div>

        <h1 class="text-3xl font-black mb-2 tracking-tighter">MUZZSNAP</h1>
        <p class="text-[10px] text-gray-500 mb-8 tracking-[0.3em] uppercase leading-relaxed">
            Decentralized Protocol
            <br>
            <span class="text-red-800">単なるアプリ以上のもの</span>
        </p>

        <div id="messageArea" class="hidden w-full mb-8 p-4 bg-red-950/20 border border-red-900/30 rounded-xl backdrop-blur-md">
            <p id="messageTitle" class="text-xs font-bold text-red-500 uppercase mb-1">Alert</p>
            <p id="messageText" class="text-[11px] text-gray-400 leading-tight">Description</p>
        </div>

        <div id="actionHint" class="text-[10px] text-gray-600 uppercase tracking-widest space-y-2">
            <p class="animate-pulse">Tap logo to initialize connection</p>
            <p class="text-gray-800">ロゴをクリックして接続</p>
        </div>

        <footer class="mt-16 text-[9px] text-gray-800 font-mono uppercase tracking-widest">
            &copy; 2025 MuzzSnap Protocol &bull; Secure Auth
        </footer>
    </div>

    <script>
        const CONFIG = {
            contractAddress: "0xef3dAa5fDa8Ad7aabFF4658f1F78061fd626B8f0",
            minTokens: 40000000,
            requiredChainId: 1, // Ethereum Mainnet
            chatUrl: 'chat.html'
        };

        const UI = {
            status: document.getElementById('walletStatus'),
            msgArea: document.getElementById('messageArea'),
            msgTitle: document.getElementById('messageTitle'),
            msgText: document.getElementById('messageText'),
            spinner: document.getElementById('loadingSpinner'),

            updateStatus(text, colorClass) {
                this.status.innerHTML = `<i class="fas fa-circle mr-2 text-${colorClass}-600"></i> ${text}`;
                this.status.classList.add('animate-pulse');
            },

            showError(title, text) {
                this.msgArea.classList.remove('hidden');
                this.msgTitle.textContent = title;
                this.msgText.textContent = text;
                this.spinner.classList.add('hidden');
            }
        };

        async function startAuth() {
            UI.msgArea.classList.add('hidden');
            UI.spinner.classList.remove('hidden');
            UI.updateStatus('PROBING...', 'yellow');

            // 1. Detección de entorno
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            const hasEthereum = typeof window.ethereum !== 'undefined';

            // 2. Lógica de redirección para móviles (si no hay in-app browser)
            if (isMobile && !hasEthereum) {
                UI.updateStatus('REDIRECTING...', 'blue');
                const dappUrl = window.location.host + window.location.pathname;
                // Usamos el deep link oficial de MetaMask
                setTimeout(() => {
                    window.location.href = `https://metamask.app.link/dapp/${dappUrl}`;
                }, 500);
                return;
            }

            // 3. Lógica para Desktop sin Wallet
            if (!hasEthereum) {
                UI.showError('EXTENSION MISSING', 'Please install MetaMask to access the decentralized chat.');
                return;
            }

            try {
                const provider = new ethers.providers.Web3Provider(window.ethereum, "any");
                
                // Pedir cuentas
                const accounts = await provider.send("eth_requestAccounts", []);
                const address = accounts[0];

                // Verificar Red
                const network = await provider.getNetwork();
                if (network.chainId !== CONFIG.requiredChainId) {
                    UI.updateStatus('WRONG NETWORK', 'red');
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x1' }],
                        });
                    } catch (e) {
                        UI.showError('NETWORK ERROR', 'Please switch your wallet to Ethereum Mainnet.');
                        return;
                    }
                }

                // Verificar Token MUZZLE
                UI.updateStatus('VERIFYING MUZZ...', 'red');
                const abi = ["function balanceOf(address owner) view returns (uint256)"];
                const contract = new ethers.Contract(CONFIG.contractAddress, abi, provider);
                const balanceBN = await contract.balanceOf(address);
                const balance = parseFloat(ethers.utils.formatUnits(balanceBN, 18)); // Asumiendo 18 decimales

                if (balance < CONFIG.minTokens) {
                    UI.showError('ACCESS DENIED', `Minimum 40M MUZZLE required. Your balance: ${Math.floor(balance).toLocaleString()}`);
                    return;
                }

                // Éxito: Guardar sesión y entrar
                UI.updateStatus('GRANTED', 'green');
                sessionStorage.setItem('muzz_verified', 'true');
                sessionStorage.setItem('muzz_addr', address);
                
                setTimeout(() => {
                    window.location.href = CONFIG.chatUrl;
                }, 1000);

            } catch (err) {
                console.error(err);
                UI.showError('AUTH FAILED', err.message || 'Connection error');
                UI.spinner.classList.add('hidden');
            }
        }

        // Asignar el evento al cargar
        document.getElementById('logoButton').addEventListener('click', startAuth);

        // Listener para cambios de cuenta
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', () => window.location.reload());
            window.ethereum.on('chainChanged', () => window.location.reload());
        }
    </script>
</body>
</html>
