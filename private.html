<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>MuzzSnap</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Orbitron:wght@400;900&display=swap');
    :root { --muzz-red: #ff0000; --muzz-bg: #050505; }
    body { background: var(--muzz-bg); color: white; font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; }
    .panel-3d { background: #0c0c0c; border: 1px solid rgba(255,0,0,0.1); border-radius: 24px; }
    .bubble-3d { padding: 12px 16px; border-radius: 18px; font-size: 14px; position: relative; max-width: 85%; word-break: break-word; }
    .bubble-3d.me { background: linear-gradient(135deg, #ff0000, #800000); align-self: flex-end; border-bottom-right-radius: 4px; }
    .bubble-3d.other { background: #1a1a1a; border: 1px solid rgba(255,255,255,0.05); align-self: flex-start; border-bottom-left-radius: 4px; }
    .hacker-input { font-family: 'Fira Code', monospace; color: #ff0000 !important; background: transparent; border: none; outline: none; }
    .custom-scroll::-webkit-scrollbar { width: 3px; }
    .custom-scroll::-webkit-scrollbar-thumb { background: var(--muzz-red); }
    /* Clase para ocultar elementos de inspeccion simple */
    .stealth-mode { filter: contrast(1.1) brightness(0.9); }
  </style>
</head>
<body>
  <div id="root" class="h-full"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const ADDR_CONTRACT = "0xef3dAa5fDa8Ad7aabFF4658f1F78061fd626B8f0";
    const ADDR_VIP = "0xBEec8F1fee64627F83F0188eAe621F367A6bCb8a".toLowerCase();
    const ABI_BALANCE = [{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}];

    // Configuración Base de Datos (Mantenida igual)
    const _fb = {
      apiKey: atob('QUl6YVN5QWUxLUpmTmRlME5LSU1kRTdwaGZFWGxtOUphcVVIMGpZ'),
      databaseURL: atob('aHR0cHM6Ly9wdWxzYXJpLWRlZmF1bHQtcnRkYi5maXJlYmFzZWlvLmNvbQ=='),
      projectId: atob('cHVsc2FyaQ==')
    };
    if (!firebase.apps.length) firebase.initializeApp(_fb);
    const db = firebase.database();

    // --- MOTOR DE CIFRADO E3EE (P2P) ---
    const _S = "Muzzle_Quantum_Shield_2026"; 
    const _enc = async (t) => {
      const e = new TextEncoder();
      const k = await crypto.subtle.importKey("raw", e.encode(_S), {name: "AES-GCM"}, false, ["encrypt"]);
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const res = await crypto.subtle.encrypt({name: "AES-GCM", iv}, k, e.encode(t));
      return btoa(JSON.stringify({ a: Array.from(iv), b: Array.from(new Uint8Array(res)) }));
    };

    const _dec = async (c) => {
      try {
        const {a, b} = JSON.parse(atob(c));
        const e = new TextEncoder();
        const k = await crypto.subtle.importKey("raw", e.encode(_S), {name: "AES-GCM"}, false, ["decrypt"]);
        const res = await crypto.subtle.decrypt({name: "AES-GCM", iv: new Uint8Array(a)}, k, new Uint8Array(b));
        return new TextDecoder().decode(res);
      } catch (err) { return "󰈡 [Contenido Cifrado]"; }
    };

    function App() {
      const [u, setU] = useState(null);
      const [m, setM] = useState([]);
      const [txt, setTxt] = useState("");
      const [ch, setCh] = useState("GENERAL");
      const [isP, setIsP] = useState(false);
      const scroll = useRef();

      useEffect(() => {
        const a = sessionStorage.getItem('muzz_wallet_address');
        if(!a) { window.location.href='login.html'; return; }
        setU({ addr: a, id: a.slice(-4) });
        listen("GENERAL");
      }, []);

      const listen = (target) => {
        db.ref('messages/' + target).limitToLast(30).on('value', async (s) => {
          const val = s.val();
          if(!val) { setM([]); return; }
          const raw = Object.values(val);
          if(target === "ARCHIVO") {
            const resolved = await Promise.all(raw.map(async x => ({...x, content: await _dec(x.content)})));
            setM(resolved);
          } else { setM(raw); }
        });
      };

      const switchCh = async (target) => {
        if(target === "ARCHIVO") {
          const userA = u.addr.toLowerCase();
          if(userA === ADDR_VIP) { setCh("ARCHIVO"); setIsP(true); listen("ARCHIVO"); return; }
          
          try {
            const provider = new ethers.BrowserProvider(window.ethereum);
            const contract = new ethers.Contract(ADDR_CONTRACT, ABI_BALANCE, provider);
            const bal = await contract.balanceOf(u.addr);
            if(bal >= 1000000000000000000000000n) { // 1M con 18 decimales
              setCh("ARCHIVO"); setIsP(true); listen("ARCHIVO");
            } else { alert("Balance insuficiente: 1,000,000 $MUZZLE requerido."); }
          } catch(e) { alert("Error de Wallet"); }
        } else { setCh(target); setIsP(false); listen(target); }
      };

      const send = async (imgData = null) => {
        const finalContent = imgData || txt;
        if(!finalContent) return;

        const payload = isP ? await _enc(finalContent) : finalContent;
        db.ref('messages/' + ch).push({
          content: payload,
          type: imgData ? "img" : "txt",
          user: `Node_${u.id}`,
          sender: u.addr,
          ts: Date.now()
        });
        setTxt("");
      };

      const handleImg = (e) => {
        const f = e.target.files[0];
        if(!f) return;
        const r = new FileReader();
        r.readAsDataURL(f);
        r.onload = (ev) => {
          const i = new Image();
          i.src = ev.target.result;
          i.onload = () => {
            const canvas = document.createElement('canvas');
            const scale = Math.min(1200 / i.width, 1200 / i.height, 1);
            canvas.width = i.width * scale;
            canvas.height = i.height * scale;
            canvas.getContext('2d').drawImage(i, 0, 0, canvas.width, canvas.height);
            send(canvas.toDataURL('image/jpeg', 0.7));
          };
        };
      };

      useEffect(() => { scroll.current?.scrollIntoView(); }, [m]);

      return (
        <div className="flex h-screen p-2 md:p-6 gap-4 stealth-mode">
          {/* Sidebar */}
          <aside className="w-64 panel-3d p-6 flex flex-col hidden md:flex">
            <h1 className="font-orbitron font-black text-xl italic mb-8">MUZZ<span className="text-red-600">SNAP</span></h1>
            <div className="flex-1 space-y-2">
              {['GENERAL', 'ESPAÑOL', 'DAO'].map(c => (
                <button key={c} onClick={()=>switchCh(c)} className={`w-full text-left px-4 py-2 rounded-lg text-xs font-bold ${ch===c?'bg-red-600/20 text-red-600':'text-gray-500'}`}># {c}</button>
              ))}
              <button onClick={()=>switchCh("ARCHIVO")} className={`w-full text-left px-4 py-3 rounded-lg text-xs font-black border ${ch==='ARCHIVO'?'bg-red-600 border-red-500':'border-red-600/30 text-red-600'}`}>
                <i className="fas fa-user-secret mr-2"></i> ARCHIVO (P2P)
              </button>
            </div>
          </aside>

          {/* Main Chat */}
          <main className={`flex-1 panel-3d flex flex-col overflow-hidden ${isP ? 'border-red-600/50 shadow-[0_0_15px_rgba(255,0,0,0.1)]' : ''}`}>
            <header className="h-14 flex items-center px-6 border-b border-white/5 bg-white/5 uppercase text-[10px] font-black tracking-widest text-red-500">
              {isP && <i className="fas fa-lock mr-2"></i>} Canal: {ch}
            </header>

            <div className="flex-1 overflow-y-auto p-4 flex flex-col gap-4 custom-scroll">
              {m.map((x, i) => (
                <div key={i} className={`flex flex-col ${x.sender === u.addr ? 'items-end' : 'items-start'}`}>
                  <div className={`bubble-3d ${x.sender === u.addr ? 'me' : 'other'}`}>
                    {x.type === 'img' ? <img src={x.content} className="rounded-lg max-h-60" /> : x.content}
                  </div>
                </div>
              ))}
              <div ref={scroll}></div>
            </div>

            <div className="p-4 bg-black/40 border-t border-white/5">
              <div className="flex items-center bg-black/50 rounded-2xl p-2 px-4 border border-white/10 focus-within:border-red-600/50">
                {isP && (
                  <label className="mr-3 text-gray-500 hover:text-red-500 cursor-pointer">
                    <i className="fas fa-camera text-lg"></i>
                    <input type="file" accept="image/*" onChange={handleImg} className="hidden" />
                  </label>
                )}
                <input value={txt} onChange={e=>setTxt(e.target.value)} onKeyDown={e=>e.key==='Enter'&&send()} placeholder="Escribir..." className="flex-1 hacker-input text-sm" />
                <button onClick={()=>send()} className="w-10 h-10 bg-red-600 rounded-xl ml-2"><i className="fas fa-paper-plane text-xs"></i></button>
              </div>
            </div>
          </main>
        </div>
      );
    }
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
