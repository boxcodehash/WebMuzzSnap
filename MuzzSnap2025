<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>MuzzSnap Chat</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <style>
      body { background-color: #111827; height: 100vh; overflow: hidden; }
      /* Evitar zoom en inputs móvil */
      input, textarea { font-size: 16px !important; } 
  </style>
</head>
<body>
  <div id="root" class="h-full"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    const ethers = window.ethers; 
    
    // --- TUS URLS DE BACKEND ---
    const CLOUD_FUNCTION_BASE_URL = "https://us-central1-pulsari.cloudfunctions.net";
    const URL_GET_NONCE = CLOUD_FUNCTION_BASE_URL + "/getNonce";
    const URL_VERIFY_MINT = CLOUD_FUNCTION_BASE_URL + "/verifyAndMintToken";

    const firebaseConfig = {
      apiKey: "AIzaSyAe1-JfNde0NKIMdE7phfEXlm9JaqUH0jY",
      authDomain: "pulsari.firebaseapp.com",
      databaseURL: "https://pulsari-default-rtdb.firebaseio.com",
      projectId: "pulsari",
      storageBucket: "pulsari.firebasestorage.app",
      messagingSenderId: "824306321233",
      appId: "1:824306321233:web:2c9bfa02170a17d560b570"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();

    function App() {
      const [user, setUser] = useState(null);
      const [status, setStatus] = useState("Initializing...");
      const [error, setError] = useState(null);
      
      // Estados Chat
      const [channels, setChannels] = useState([]);
      const [currentChannel, setCurrentChannel] = useState(null);
      const [messages, setMessages] = useState([]);
      const [input, setInput] = useState("");
      const [showSidebar, setShowSidebar] = useState(true); // Móvil: empieza true (o false si prefieres)
      
      const dummyRef = useRef();

      // --- AUTO LOGIN (MEJORADO) ---
      useEffect(() => {
        const initLogin = async () => {
            const pending = localStorage.getItem('muzz_login_pending');
            
            // 1. Esperar a que Firebase revise sesión existente
            auth.onAuthStateChanged(u => {
                if(u) {
                    setUser(u);
                    localStorage.removeItem('muzz_login_pending');
                } else if (pending === 'true') {
                    // Si no hay sesión pero hay pending, intentamos Web3
                    performWeb3Login();
                } else {
                    setStatus("Please login via Portal");
                }
            });
        };
        
        // Pequeño delay para dar tiempo a window.ethereum
        setTimeout(initLogin, 1000);
      }, []);

      const performWeb3Login = async () => {
        try {
            setStatus("Locating Wallet...");
            if(!window.ethereum) throw new Error("Wallet not found");
            
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            // Solicitar cuentas de nuevo por si acaso
            await window.ethereum.request({ method: 'eth_requestAccounts' });
            const signer = provider.getSigner();
            const address = await signer.getAddress();

            // 1. Nonce
            setStatus("Verifying Identity...");
            const nRes = await fetch(`${URL_GET_NONCE}?address=${address}`);
            if(!nRes.ok) throw new Error("Backend Connect Error");
            const { nonce } = await nRes.json();

            // 2. Firmar
            setStatus("Please sign verification...");
            const msg = `Please sign this message to authenticate with Pulsari System. Nonce: ${nonce}`;
            const signature = await signer.signMessage(msg);

            // 3. Verificar
            setStatus("Authenticating Token...");
            const vRes = await fetch(URL_VERIFY_MINT, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ walletAddress: address, signature, nonce, originalMessage: msg })
            });
            const result = await vRes.json();

            if(result.firebaseToken) {
                await auth.signInWithCustomToken(result.firebaseToken);
                localStorage.removeItem('muzz_login_pending');
            } else {
                throw new Error(result.error || "Auth Failed");
            }

        } catch (err) {
            console.error(err);
            setError(err.message);
            setStatus("Login Failed");
            // Limpiar flag para no buclear
            localStorage.removeItem('muzz_login_pending');
        }
      };

      // --- CARGA DE DATOS ---
      useEffect(() => {
        if(!user) return;
        // Cargar canales
        database.ref('channels').on('value', s => {
            const data = s.val();
            const list = data ? Object.keys(data).map(k => ({id:k, ...data[k]})) : [];
            setChannels(list);
            if(!currentChannel && list.length > 0) setCurrentChannel(list[0]);
        });
      }, [user]);

      useEffect(() => {
        if(!currentChannel) return;
        const ref = database.ref(`messages/${currentChannel.id}`);
        ref.limitToLast(50).on('value', s => {
            const data = s.val();
            const list = data ? Object.keys(data).map(k => ({id:k, ...data[k]})) : [];
            setMessages(list);
        });
        return () => ref.off();
      }, [currentChannel]);

      useEffect(() => dummyRef.current?.scrollIntoView({behavior:'smooth'}), [messages]);

      const sendMsg = () => {
        if(!input.trim() || !currentChannel) return;
        database.ref(`messages/${currentChannel.id}`).push({
            content: input,
            userId: user.uid,
            username: user.uid.substring(0,6), // O nickname real si lo tienes
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });
        setInput("");
      };

      // --- RENDER: LOGIN / ERROR ---
      if (!user) {
        return (
            <div className="flex flex-col items-center justify-center h-full bg-gray-900 text-white p-6 text-center">
                <div className="mb-6 animate-pulse">
                    <img src="https://img1.wsimg.com/isteam/ip/ac9578cb-a6ce-417e-8ad5-b2d6701462eb/1000027796.png/:/rs=w:1440,h:1440" className="w-20 h-20 mx-auto"/>
                </div>
                
                {error ? (
                    <div className="bg-red-900/50 p-4 rounded-lg border border-red-800">
                        <p className="text-red-200 font-bold mb-2">Error</p>
                        <p className="text-xs text-red-300 mb-4">{error}</p>
                        <button onClick={() => window.location.href='index.html'} className="px-4 py-2 bg-gray-800 rounded text-sm">Back to Portal</button>
                    </div>
                ) : (
                    <div>
                        <i className="fas fa-circle-notch fa-spin text-purple-500 text-2xl mb-4"></i>
                        <p className="text-gray-400 text-sm tracking-wider">{status}</p>
                    </div>
                )}
            </div>
        );
      }

      // --- RENDER: CHAT APP ---
      return (
        <div className="flex h-full bg-gray-900 overflow-hidden relative">
            
            {/* Sidebar Móvil (Overlay) */}
            {showSidebar && (
                <div className="absolute inset-0 bg-black/80 z-40 lg:hidden" onClick={() => setShowSidebar(false)}></div>
            )}

            {/* Sidebar Panel */}
            <div className={`absolute lg:relative z-50 w-64 h-full bg-gray-800 border-r border-gray-700 transform transition-transform duration-300 ${showSidebar ? 'translate-x-0' : '-translate-x-full'} lg:translate-x-0 flex flex-col`}>
                <div className="h-14 flex items-center justify-between px-4 border-b border-gray-700 shrink-0">
                    <span className="font-bold text-white">MuzzSnap</span>
                    <button onClick={() => setShowSidebar(false)} className="lg:hidden text-gray-400">✕</button>
                </div>
                
                <div className="flex-1 overflow-y-auto p-2 space-y-1">
                    <div className="px-2 text-xs font-bold text-gray-500 uppercase mb-2 mt-2">Channels</div>
                    {channels.map(c => (
                        <button key={c.id} 
                            onClick={() => { setCurrentChannel(c); setShowSidebar(false); }}
                            className={`w-full text-left px-3 py-2 rounded-lg text-sm transition ${currentChannel?.id === c.id ? 'bg-purple-600 text-white' : 'text-gray-400 hover:bg-gray-700'}`}>
                            # {c.name}
                        </button>
                    ))}
                </div>

                <div className="p-4 border-t border-gray-700 bg-gray-800 shrink-0">
                    <button onClick={() => auth.signOut()} className="text-red-400 text-sm flex items-center gap-2 hover:text-red-300">
                        <i className="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>

            {/* Main Chat Area */}
            <div className="flex-1 flex flex-col w-full bg-gray-900">
                {/* Header */}
                <div className="h-14 bg-gray-800 border-b border-gray-700 flex items-center px-4 shrink-0 shadow-sm z-10">
                    <button onClick={() => setShowSidebar(true)} className="lg:hidden mr-4 text-gray-300 text-xl">
                        <i className="fas fa-bars"></i>
                    </button>
                    <h3 className="font-bold text-white truncate">
                        {currentChannel ? `# ${currentChannel.name}` : 'Select Channel'}
                    </h3>
                </div>

                {/* Messages */}
                <div className="flex-1 overflow-y-auto p-4 space-y-3">
                    {messages.map(m => {
                        const isMe = m.userId === user.uid;
                        return (
                            <div key={m.id} className={`flex ${isMe ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[80%] px-4 py-2 rounded-2xl text-sm ${isMe ? 'bg-purple-600 text-white rounded-br-none' : 'bg-gray-800 text-gray-200 rounded-bl-none'}`}>
                                    {!isMe && <div className="text-[10px] text-purple-300 font-bold mb-1">{m.username}</div>}
                                    {m.content}
                                </div>
                            </div>
                        )
                    })}
                    <div ref={dummyRef}></div>
                </div>

                {/* Input Area */}
                <div className="p-3 bg-gray-800 border-t border-gray-700 shrink-0 safe-area-pb">
                    <div className="flex gap-2">
                        <input 
                            className="flex-1 bg-gray-900 border border-gray-600 rounded-full px-4 py-2 text-white focus:outline-none focus:border-purple-500 transition"
                            placeholder="Message..."
                            value={input}
                            onChange={e => setInput(e.target.value)}
                            onKeyDown={e => e.key === 'Enter' && sendMsg()}
                        />
                        <button onClick={sendMsg} disabled={!input.trim()} className="w-10 h-10 bg-purple-600 rounded-full text-white flex items-center justify-center disabled:opacity-50">
                            <i className="fas fa-paper-plane text-sm"></i>
                        </button>
                    </div>
                </div>
            </div>

        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
