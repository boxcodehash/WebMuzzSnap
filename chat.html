<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>MuzzSnap - Secure Channel</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
  
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
    body { font-family: 'Inter', sans-serif; background-color: #0a0a0a; overflow: hidden; }
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: #111827; }
    ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 2px; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const firebaseConfig = {
      apiKey: "AIzaSyAe1-JfNde0NKIMdE7phfEXlm9JaqUH0jY",
      authDomain: "pulsari.firebaseapp.com",
      databaseURL: "https://pulsari-default-rtdb.firebaseio.com",
      projectId: "pulsari",
      storageBucket: "pulsari.firebasestorage.app",
      messagingSenderId: "824306321233",
      appId: "1:824306321233:web:2c9bfa02170a17d560b570"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();
    
    const CONTRACT_ADDRESS = "0xef3dAa5fDa8Ad7aabFF4658f1F78061fd626B8f0";
    const MIN_REQUIRED = 40000000;
    const EMOJIS = ['ðŸ˜€','ðŸ˜ƒ','ðŸ˜„','ðŸ˜','ðŸ˜…','ðŸ˜‚','ðŸ˜‰','ðŸ˜Š','ðŸ¥°','ðŸ˜','ðŸ˜˜','ðŸ˜œ','ðŸ˜Ž','ðŸ¥³','ðŸ˜¡','ðŸ˜­','ðŸ‘','ðŸ‘Ž','ðŸ”¥','â¤ï¸'];

    const ERC20_ABI = [
        "function balanceOf(address owner) view returns (uint256)",
        "function decimals() view returns (uint8)"
    ];

    function App() {
      const [user, setUser] = useState(null);
      const [isLoading, setIsLoading] = useState(true);
      const [error, setError] = useState(null);

      // Chat Data
      const [channels, setChannels] = useState([]);
      const [selectedChannel, setSelectedChannel] = useState(null);
      const [messages, setMessages] = useState([]);
      const [onlineUsers, setOnlineUsers] = useState([]);
      
      const [inputText, setInputText] = useState("");
      const [showSidebar, setShowSidebar] = useState(window.innerWidth > 1024);
      const [showEmoji, setShowEmoji] = useState(false);
      const [showNewChannel, setShowNewChannel] = useState(false);
      const [newChName, setNewChName] = useState("");
      
      const dummyRef = useRef(null);

      useEffect(() => {
        const initAuth = async () => {
          if (typeof window.ethereum !== 'undefined') {
            try {
              const provider = new ethers.providers.Web3Provider(window.ethereum);
              const accounts = await provider.send("eth_accounts", []);
              
              if (accounts.length > 0) {
                const address = accounts[0];

                // --- BALANCE CHECK (Security Layer 2) ---
                const contract = new ethers.Contract(CONTRACT_ADDRESS, ERC20_ABI, provider);
                const decimals = await contract.decimals();
                const balanceBN = await contract.balanceOf(address);
                const balance = parseFloat(ethers.utils.formatUnits(balanceBN, decimals));

                if (balance < MIN_REQUIRED) {
                    throw new Error("need Minimum 40M Muzz");
                }
                // ----------------------------------------

                await auth.signInAnonymously();
                const nickname = `User ${address.slice(0,5)}...${address.slice(-4)}`;
                
                setUser({ uid: auth.currentUser.uid, address: address, nickname: nickname });
                
                database.ref('users/' + auth.currentUser.uid).update({
                   username: nickname,
                   wallet: address,
                   lastSeen: firebase.database.ServerValue.TIMESTAMP
                });

              } else {
                window.location.href = 'index.html';
              }
            } catch (err) {
              console.error(err);
              if (err.message.includes("need Minimum 40M Muzz")) {
                  setError("need Minimum 40M Muzz");
                  setTimeout(() => window.location.href = 'index.html', 3000);
              } else {
                  setError("Connection failed. Return to login.");
              }
            }
          } else {
             setError("Wallet not found.");
          }
          setIsLoading(false);
        };
        
        setTimeout(initAuth, 500);
      }, []);

      // Data Listeners
      useEffect(() => {
        if (!user) return;

        const presenceRef = database.ref('presence/' + user.uid);
        const connectedRef = database.ref('.info/connected');
        connectedRef.on('value', (snap) => {
          if (snap.val()) {
            presenceRef.onDisconnect().remove();
            presenceRef.set({ online: true, username: user.nickname });
          }
        });

        const chRef = database.ref('channels');
        chRef.on('value', (snap) => {
          const data = snap.val();
          const list = data ? Object.keys(data).map(k => ({ id: k, ...data[k] })) : [];
          setChannels(list);
          if (!selectedChannel && list.length > 0) setSelectedChannel(list[0]);
        });

        const usersRef = database.ref('presence');
        usersRef.on('value', (snap) => {
           const data = snap.val();
           setOnlineUsers(data ? Object.values(data) : []);
        });

        return () => { chRef.off(); usersRef.off(); connectedRef.off(); }
      }, [user]);

      useEffect(() => {
        if (!selectedChannel) return;
        const msgRef = database.ref('messages/' + selectedChannel.id).limitToLast(50);
        msgRef.on('value', (snap) => {
          const data = snap.val();
          setMessages(data ? Object.keys(data).map(k => ({ id: k, ...data[k] })) : []);
        });
        return () => msgRef.off();
      }, [selectedChannel]);

      useEffect(() => {
        dummyRef.current?.scrollIntoView({ behavior: 'smooth' });
      }, [messages]);

      const handleSend = async () => {
        if (!inputText.trim() || !selectedChannel) return;
        await database.ref('messages/' + selectedChannel.id).push({
          content: inputText,
          username: user.nickname,
          userId: user.uid,
          timestamp: firebase.database.ServerValue.TIMESTAMP
        });
        setInputText("");
        setShowEmoji(false);
      };

      const handleCreateChannel = async () => {
        if(!newChName.trim()) return;
        await database.ref('channels').push({
            name: newChName.trim(),
            createdBy: user.uid
        });
        setNewChName("");
        setShowNewChannel(false);
      };

      const handleLogout = async () => {
          await auth.signOut();
          window.location.href = 'index.html';
      };

      if (isLoading) return (
        <div className="h-screen w-full bg-gray-900 flex items-center justify-center text-white">
          <i className="fas fa-circle-notch fa-spin text-4xl text-purple-600"></i>
        </div>
      );

      if (error) return (
        <div className="h-screen w-full bg-gray-900 flex flex-col items-center justify-center text-white gap-4 p-4 text-center">
          <i className="fas fa-ban text-4xl text-red-500"></i>
          <p className="text-xl font-bold text-red-400">{error}</p>
          <a href="index.html" className="bg-gray-800 border border-gray-700 px-6 py-2 rounded-lg hover:bg-gray-700 transition">Back to Login</a>
        </div>
      );

      return (
        <div className="flex h-screen bg-gray-900 text-gray-100 overflow-hidden relative">
            {!showSidebar && (
                <button onClick={() => setShowSidebar(true)} className="lg:hidden absolute top-4 left-4 z-40 bg-gray-800 p-2 rounded shadow">
                    <i className="fas fa-bars"></i>
                </button>
            )}

            <div className={`fixed inset-y-0 left-0 z-50 w-64 bg-gray-800 border-r border-gray-700 transform transition-transform duration-300 ${showSidebar ? 'translate-x-0' : '-translate-x-full'} lg:relative lg:translate-x-0`}>
                <div className="h-16 flex items-center justify-between px-4 border-b border-gray-700">
                    <h1 className="font-bold text-lg text-purple-400">MuzzSnap</h1>
                    <button onClick={() => setShowSidebar(false)} className="lg:hidden text-gray-400">âœ•</button>
                </div>
                <div className="p-4 overflow-y-auto h-[calc(100vh-4rem)]">
                    <div className="flex justify-between items-center mb-2 text-xs font-bold text-gray-500 uppercase">
                        <span>Channels</span>
                        <button onClick={() => setShowNewChannel(true)} className="hover:text-white text-lg">+</button>
                    </div>
                    <div className="space-y-1 mb-6">
                        {channels.map(ch => (
                            <button key={ch.id} onClick={() => { setSelectedChannel(ch); if(window.innerWidth < 1024) setShowSidebar(false); }}
                                className={`w-full text-left px-3 py-2 rounded text-sm truncate ${selectedChannel?.id === ch.id ? 'bg-purple-900/50 text-white' : 'text-gray-400 hover:bg-gray-700'}`}>
                                # {ch.name}
                            </button>
                        ))}
                    </div>
                    <div className="text-xs font-bold text-gray-500 uppercase mb-2">Online ({onlineUsers.length})</div>
                    <div className="space-y-2">
                        {onlineUsers.map((u, i) => (
                            <div key={i} className="flex items-center gap-2 text-sm text-gray-400">
                                <span className="w-2 h-2 rounded-full bg-green-500"></span>
                                <span className="truncate">{u.username}</span>
                            </div>
                        ))}
                    </div>
                    <div className="absolute bottom-0 left-0 right-0 p-4 bg-gray-800 border-t border-gray-700">
                        <div className="text-xs text-gray-500 mb-1">Connected as</div>
                        <div className="font-mono text-xs text-yellow-500 truncate mb-3">{user.address}</div>
                        <button onClick={handleLogout} className="w-full py-2 bg-red-900/30 text-red-400 rounded text-xs hover:bg-red-900/50">Disconnect</button>
                    </div>
                </div>
            </div>

            <div className="flex-1 flex flex-col min-w-0 bg-gray-900">
                <div className="h-16 border-b border-gray-700 flex items-center px-4 lg:px-6 bg-gray-800/50 backdrop-blur">
                    <div className="ml-8 lg:ml-0 font-bold text-lg">
                        {selectedChannel ? `# ${selectedChannel.name}` : 'Select a channel'}
                    </div>
                </div>
                <div className="flex-1 overflow-y-auto p-4 space-y-4">
                    {messages.map(msg => {
                        const isMe = msg.userId === user.uid;
                        return (
                            <div key={msg.id} className={`flex ${isMe ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[85%] lg:max-w-[70%] rounded-2xl px-4 py-2 text-sm ${isMe ? 'bg-purple-600 text-white rounded-br-none' : 'bg-gray-800 text-gray-200 rounded-bl-none'}`}>
                                    {!isMe && <div className="text-[10px] text-purple-300 font-bold mb-0.5">{msg.username}</div>}
                                    {msg.content}
                                </div>
                            </div>
                        )
                    })}
                    <div ref={dummyRef}></div>
                </div>
                {selectedChannel && (
                    <div className="p-3 border-t border-gray-700 bg-gray-800">
                        <div className="relative flex items-center gap-2 bg-gray-900 rounded-full px-4 py-2 border border-gray-700">
                            <button onClick={() => setShowEmoji(!showEmoji)} className="text-gray-400 hover:text-yellow-400"><i className="far fa-smile text-xl"></i></button>
                            {showEmoji && (
                                <div className="absolute bottom-14 left-0 bg-gray-800 p-2 rounded-xl shadow-xl grid grid-cols-5 gap-1 border border-gray-700 w-48 h-32 overflow-y-auto">
                                    {EMOJIS.map(e => <button key={e} onClick={() => setInputText(prev => prev + e)} className="text-xl hover:bg-gray-700 rounded p-1">{e}</button>)}
                                </div>
                            )}
                            <input value={inputText} onChange={e => setInputText(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleSend()} className="flex-1 bg-transparent border-none focus:ring-0 text-white placeholder-gray-500" placeholder={`Message #${selectedChannel.name}`} />
                            <button onClick={handleSend} disabled={!inputText.trim()} className="text-purple-500 disabled:opacity-50 hover:text-purple-400"><i className="fas fa-paper-plane text-lg"></i></button>
                        </div>
                    </div>
                )}
            </div>

            {showNewChannel && (
                <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
                    <div className="bg-gray-800 p-6 rounded-xl w-full max-w-sm border border-gray-700">
                        <h3 className="font-bold mb-4">New Channel</h3>
                        <input autoFocus value={newChName} onChange={e => setNewChName(e.target.value.toLowerCase().replace(/\s/g, '-'))} className="w-full bg-gray-900 border border-gray-600 rounded p-2 mb-4 text-white" placeholder="channel-name" />
                        <div className="flex justify-end gap-2">
                            <button onClick={() => setShowNewChannel(false)} className="px-4 py-2 text-gray-400">Cancel</button>
                            <button onClick={handleCreateChannel} className="bg-purple-600 px-4 py-2 rounded text-white">Create</button>
                        </div>
                    </div>
                </div>
            )}
        </div>
      );
    }
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
