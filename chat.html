<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>MuzzSnap ‚Äî Chat</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
    body { font-family: 'Inter', sans-serif; overflow: hidden; background-color: #0a0a0a; }
    
    /* Fondo animado sutil */
    .muzz-background {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
      background: radial-gradient(circle at 10% 50%, rgba(100, 100, 100, 0.08) 0%, transparent 50%),
                  radial-gradient(circle at 90% 80%, rgba(50, 50, 50, 0.1) 0%, transparent 60%);
    }
    
    /* Scrollbar personalizada */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #111827; }
    ::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }
  </style>
</head>
<body>

  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useLayoutEffect } = React;

    // --- CONFIGURACI√ìN FIREBASE ---
    const firebaseConfig = {
      apiKey: "AIzaSyAe1-JfNde0NKIMdE7phfEXlm9JaqUH0jY",
      authDomain: "pulsari.firebaseapp.com",
      databaseURL: "https://pulsari-default-rtdb.firebaseio.com",
      projectId: "pulsari",
      storageBucket: "pulsari.firebasestorage.app",
      messagingSenderId: "824306321233",
      appId: "1:824306321233:web:2c9bfa02170a17d560b570"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();

    const EMOJIS = ['üòÄ','üòÉ','üòÑ','üòÅ','üòÜ','üòÖ','ü§£','üòÇ','üôÇ','üôÉ','üòâ','üòä','üòá','ü•∞','üòç','ü§©','üòò','üòó','üòö','üòô'];
    const CONTRACT_ADDRESS = "0xef3dAa5fDa8Ad7aabFF4658f1F78061fd626B8f0";
    const LOGIN_MESSAGE = `Welcome to MuzzSnap.News\n\nContract: ${CONTRACT_ADDRESS}\n\nSign this message to authenticate securely.`;

    // ================= COMPONENTE PRINCIPAL (APP) =================
    function App() {
      const [user, setUser] = useState(null); // Objeto { address, uid, nickname }
      const [isConnecting, setIsConnecting] = useState(false);
      const [errorMsg, setErrorMsg] = useState('');

      // Funci√≥n de Login
      const handleConnect = async () => {
        if (typeof window.ethereum === 'undefined') {
          setErrorMsg("Please install MetaMask.");
          return;
        }
        setIsConnecting(true);
        setErrorMsg('');

        try {
          // 1. Conectar Wallet
          const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
          const address = accounts[0];

          // 2. Firmar mensaje (Autenticaci√≥n simulada)
          await window.ethereum.request({
            method: 'personal_sign',
            params: [LOGIN_MESSAGE, address],
          });

          // 3. Login An√≥nimo en Firebase
          const userCred = await auth.signInAnonymously();
          
          setUser({
            address: address,
            uid: userCred.user.uid,
            nickname: `User_${address.slice(0,4)}...${address.slice(-4)}`
          });

        } catch (error) {
          console.error(error);
          setErrorMsg("Connection failed or rejected.");
        } finally {
          setIsConnecting(false);
        }
      };

      const handleLogout = () => {
        auth.signOut();
        setUser(null);
      };

      return (
        <>
          <div className="muzz-background"></div>
          {/* Renderizado Condicional: Si hay usuario -> Chat, si no -> Login */}
          {user ? (
            <SecureChat user={user} onLogout={handleLogout} />
          ) : (
            <LoginScreen 
              onConnect={handleConnect} 
              isConnecting={isConnecting} 
              errorMsg={errorMsg} 
            />
          )}
        </>
      );
    }

    // ================= PANTALLA DE LOGIN =================
    function LoginScreen({ onConnect, isConnecting, errorMsg }) {
      return (
        <div className="flex flex-col items-center justify-center min-h-screen text-white p-4 relative z-10">
          
          <div className="text-center max-w-sm w-full">
            {/* Logo / Bot√≥n */}
            <button 
              onClick={onConnect} 
              disabled={isConnecting}
              className="mb-8 relative group transition-transform hover:scale-105 active:scale-95"
            >
              <img
                src="https://img1.wsimg.com/isteam/ip/ac9578cb-a6ce-417e-8ad5-b2d6701462eb/1000030902.png/:/rs=w:1440,h:1440"
                alt="MuzzSnap Logo"
                className={`w-36 h-36 mx-auto rounded-xl shadow-2xl transition duration-500 ${isConnecting ? 'opacity-50 blur-sm' : 'group-hover:rotate-3'}`}
                onError={(e) => e.target.src='https://placehold.co/144x144/1f2937/ffffff?text=MUZZ'}
              />
              {isConnecting && (
                <div className="absolute inset-0 flex items-center justify-center">
                  <i className="fas fa-spinner fa-spin text-4xl"></i>
                </div>
              )}
            </button>

            <h1 className="text-4xl sm:text-5xl font-extrabold mb-2 tracking-tight">MuzzSnap</h1>
            <p className="text-xs sm:text-sm font-light text-gray-400 mb-8 tracking-wider">
              üîë Much more than a simple app...‚åõÔ∏è
            </p>

            {errorMsg && (
              <div className="mb-6 p-3 bg-red-900/50 border border-red-700 rounded text-sm text-red-200">
                {errorMsg}
              </div>
            )}

            <div className="flex justify-center space-x-8 mb-12">
              <a href="#" className="hover:text-blue-400 transition transform hover:scale-110"><i className="fab fa-x-twitter text-3xl"></i></a>
              <a href="#" className="hover:text-blue-400 transition transform hover:scale-110"><i className="fab fa-telegram-plane text-3xl"></i></a>
            </div>

            <footer className="text-xs font-light text-gray-600">
              MuzzSnap 2025‚Ñ¢ &copy; By.Ryachu
            </footer>
          </div>
        </div>
      );
    }

    // ================= COMPONENTE CHAT =================
    function SecureChat({ user, onLogout }) {
      const [channels, setChannels] = useState([]);
      const [selectedChannel, setSelectedChannel] = useState(null);
      const [messages, setMessages] = useState([]);
      const [draftMessage, setDraftMessage] = useState('');
      const [onlineUsers, setOnlineUsers] = useState([]);
      
      // UI State
      const [isMobile, setIsMobile] = useState(window.innerWidth < 1024);
      const [showSidebar, setShowSidebar] = useState(!isMobile);
      const [showNewChannelModal, setShowNewChannelModal] = useState(false);
      const [newChannelName, setNewChannelName] = useState('');
      const [showEmojiPicker, setShowEmojiPicker] = useState(false);
      
      const messagesEndRef = useRef(null);

      // Responsive handler
      useEffect(() => {
        const handleResize = () => {
          const mobile = window.innerWidth < 1024;
          setIsMobile(mobile);
          if (!mobile) setShowSidebar(true);
        };
        window.addEventListener('resize', handleResize);
        return () => window.removeEventListener('resize', handleResize);
      }, []);

      // Presencia (Online Status)
      useEffect(() => {
        const presenceRef = database.ref('presence/' + user.uid);
        const connectedRef = database.ref('.info/connected');
        
        connectedRef.on('value', (snap) => {
          if (snap.val()) {
            presenceRef.onDisconnect().remove();
            presenceRef.set({ online: true, username: user.nickname });
          }
        });
        
        // Cargar usuarios online
        const usersRef = database.ref('presence');
        usersRef.on('value', snap => {
          const data = snap.val();
          setOnlineUsers(data ? Object.values(data) : []);
        });

        return () => {
          presenceRef.remove(); // Cleanup al salir
          connectedRef.off();
          usersRef.off();
        }
      }, [user]);

      // Cargar Canales
      useEffect(() => {
        const ref = database.ref('channels');
        ref.on('value', (snap) => {
          const data = snap.val();
          const list = data ? Object.keys(data).map(k => ({ id: k, ...data[k] })) : [];
          setChannels(list);
          // Seleccionar el primero por defecto si no hay selecci√≥n y hay canales
          if (!selectedChannel && list.length > 0) setSelectedChannel(list[0]);
        });
        return () => ref.off();
      }, []); // Array vac√≠o para que no parpadee al cambiar channel

      // Cargar Mensajes del Canal Actual
      useEffect(() => {
        if (!selectedChannel) {
          setMessages([]);
          return;
        }
        const ref = database.ref('messages/' + selectedChannel.id).limitToLast(50);
        
        const handleMsg = (snap) => {
          const data = snap.val();
          if (data) {
            const list = Object.keys(data).map(k => ({ id: k, ...data[k] }));
            setMessages(list);
          } else {
            setMessages([]);
          }
        };
        
        ref.on('value', handleMsg);
        return () => ref.off();
      }, [selectedChannel]); // Re-ejecutar solo si cambia el canal

      // Scroll autom√°tico al fondo
      useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      }, [messages]);

      const sendMessage = async () => {
        if (!draftMessage.trim() || !selectedChannel) return;
        try {
          await database.ref('messages/' + selectedChannel.id).push({
            content: draftMessage.trim(),
            userId: user.uid,
            username: user.nickname,
            timestamp: firebase.database.ServerValue.TIMESTAMP
          });
          setDraftMessage('');
          setShowEmojiPicker(false);
        } catch (e) {
          alert("Error sending. Check console.");
        }
      };

      const createChannel = async () => {
        if (!newChannelName.trim()) return;
        await database.ref('channels').push({ name: newChannelName.trim(), createdBy: user.uid });
        setNewChannelName('');
        setShowNewChannelModal(false);
      };

      return (
        <div className="flex w-full h-screen overflow-hidden bg-gray-900 text-white">
          
          {/* Overlay M√≥vil */}
          {isMobile && showSidebar && (
            <div className="fixed inset-0 bg-black/60 z-40" onClick={() => setShowSidebar(false)} />
          )}

          {/* SIDEBAR */}
          <aside className={`
            fixed lg:relative z-50 w-64 h-full bg-gray-800 border-r border-gray-700 flex flex-col transition-transform duration-300
            ${showSidebar ? 'translate-x-0' : '-translate-x-full lg:translate-x-0 lg:w-64'}
          `}>
            <div className="p-4 border-b border-gray-700 flex justify-between items-center bg-gray-800">
              <h2 className="font-bold flex items-center gap-2">
                <i className="fas fa-shield-dog text-purple-500"></i> MuzzSnap
              </h2>
              {isMobile && <button onClick={() => setShowSidebar(false)} className="text-gray-400">‚úï</button>}
            </div>

            <div className="flex-1 overflow-y-auto p-2 space-y-1">
              {/* Channels Header */}
              <div className="flex justify-between items-center px-2 py-2 text-gray-400 mt-2">
                <span className="text-xs font-bold uppercase tracking-wider">Channels</span>
                <button onClick={() => setShowNewChannelModal(true)} className="hover:text-white bg-gray-700 rounded px-1.5 text-xs py-0.5 transition">+</button>
              </div>
              
              {channels.map(c => (
                <button
                  key={c.id}
                  onClick={() => {
                    setSelectedChannel(c);
                    if (isMobile) setShowSidebar(false);
                  }}
                  className={`w-full text-left px-3 py-2 rounded-lg flex items-center gap-2 text-sm transition-colors ${
                    selectedChannel?.id === c.id ? 'bg-gray-700 text-white shadow' : 'text-gray-400 hover:bg-gray-700/50 hover:text-gray-200'
                  }`}
                >
                  <span className="text-gray-500">#</span> <span className="truncate">{c.name}</span>
                </button>
              ))}

              {/* Online Users */}
              <div className="mt-6 px-2 py-2 text-gray-400 text-xs font-bold uppercase tracking-wider border-t border-gray-700/50 pt-4">
                Online ‚Äî {onlineUsers.length}
              </div>
              <div className="space-y-1">
                {onlineUsers.map((u, i) => (
                  <div key={i} className="px-3 py-1.5 text-gray-400 text-sm flex items-center gap-2 rounded hover:bg-gray-700/30">
                    <div className="w-2 h-2 bg-green-500 rounded-full shadow-[0_0_5px_#22c55e]"></div>
                    <span className="truncate opacity-90">{u.username}</span>
                  </div>
                ))}
              </div>
            </div>
            
            {/* Footer User Info */}
            <div className="p-3 bg-gray-900 border-t border-gray-700">
              <div className="flex items-center justify-between mb-2">
                <div className="text-xs text-gray-400 truncate pr-2">
                   Connected as: <span className="text-green-400">{user.nickname}</span>
                </div>
              </div>
              <button onClick={onLogout} className="w-full py-2 text-xs font-medium bg-red-900/30 text-red-400 hover:bg-red-900/50 rounded transition">
                 <i className="fas fa-sign-out-alt mr-1"></i> Disconnect
               </button>
            </div>
          </aside>

          {/* MAIN CHAT AREA */}
          <main className="flex-1 flex flex-col min-w-0 bg-gray-900 relative">
            {/* Top Bar */}
            <header className="h-14 bg-gray-800 border-b border-gray-700 flex items-center px-4 shadow-sm z-10">
              <button 
                onClick={() => setShowSidebar(true)} 
                className="mr-4 text-gray-400 hover:text-white lg:hidden"
              >
                <i className="fas fa-bars text-xl"></i>
              </button>
              <h3 className="font-bold text-white truncate flex items-center gap-2">
                <span className="text-gray-500 text-lg">#</span>
                {selectedChannel ? selectedChannel.name : 'Select a channel'}
              </h3>
            </header>

            {/* Messages List */}
            <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-900 scroll-smooth">
              {messages.length === 0 && selectedChannel && (
                <div className="text-center text-gray-600 mt-10">
                  <i className="fas fa-comments text-4xl mb-2 opacity-20"></i>
                  <p>Be the first to write in #{selectedChannel.name}!</p>
                </div>
              )}
              
              {messages.map(msg => {
                const isMe = msg.userId === user.uid;
                return (
                  <div key={msg.id} className={`flex ${isMe ? 'justify-end' : 'justify-start'} group`}>
                    <div className={`max-w-[85%] sm:max-w-[70%] rounded-2xl px-4 py-2 shadow-md text-sm relative ${
                      isMe 
                        ? 'bg-gradient-to-br from-purple-600 to-indigo-600 text-white rounded-br-none' 
                        : 'bg-gray-800 border border-gray-700 text-gray-100 rounded-bl-none'
                    }`}>
                      {!isMe && (
                        <div className="text-[10px] uppercase font-bold text-purple-400 mb-0.5 tracking-wide opacity-80">
                          {msg.username}
                        </div>
                      )}
                      <p className="break-words leading-relaxed">{msg.content}</p>
                      {/* Timestamp tooltip could go here */}
                    </div>
                  </div>
                );
              })}
              <div ref={messagesEndRef} />
            </div>

            {/* Input Area */}
            {selectedChannel ? (
              <div className="p-3 bg-gray-800 border-t border-gray-700">
                <div className="relative flex items-end gap-2 bg-gray-900 p-2 rounded-xl border border-gray-700 focus-within:border-purple-500 transition-colors">
                  
                  {/* Emoji Picker (Popup) */}
                  {showEmojiPicker && (
                    <div className="absolute bottom-14 left-0 bg-gray-800 border border-gray-700 p-2 rounded-lg shadow-2xl grid grid-cols-5 gap-1 w-64 h-48 overflow-y-auto z-50">
                      {EMOJIS.map(e => (
                        <button key={e} onClick={() => setDraftMessage(p => p + e)} className="text-xl hover:bg-gray-700 p-1 rounded transition">
                          {e}
                        </button>
                      ))}
                    </div>
                  )}

                  <button 
                    onClick={() => setShowEmojiPicker(!showEmojiPicker)}
                    className="p-2 text-gray-400 hover:text-yellow-400 transition-colors rounded-full hover:bg-gray-800"
                  >
                    <i className="far fa-smile text-xl"></i>
                  </button>

                  <textarea
                    value={draftMessage}
                    onChange={(e) => setDraftMessage(e.target.value)}
                    onKeyDown={(e) => {
                      if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                      }
                    }}
                    className="flex-1 bg-transparent text-white max-h-24 resize-none focus:outline-none py-2 text-sm scrollbar-hide"
                    placeholder={`Message #${selectedChannel.name}`}
                    rows="1"
                  />

                  <button
                    onClick={sendMessage}
                    disabled={!draftMessage.trim()}
                    className="p-2 rounded-lg bg-purple-600 text-white hover:bg-purple-500 disabled:opacity-50 disabled:hover:bg-purple-600 transition-all shadow-lg"
                  >
                    <i className="fas fa-paper-plane"></i>
                  </button>
                </div>
              </div>
            ) : (
              <div className="p-4 bg-gray-800 border-t border-gray-700 text-center text-gray-500 text-sm">
                Select a channel to start chatting
              </div>
            )}
          </main>

          {/* MODAL CREAR CANAL */}
          {showNewChannelModal && (
            <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-[100] backdrop-blur-sm">
              <div className="bg-gray-800 p-6 rounded-2xl w-full max-w-sm border border-gray-700 shadow-2xl transform transition-all scale-100">
                <h3 className="text-xl font-bold mb-1 text-white">New Channel</h3>
                <p className="text-gray-400 text-xs mb-4">Create a space for a new topic.</p>
                
                <div className="space-y-4">
                  <div>
                    <label className="text-xs font-semibold text-gray-500 uppercase ml-1">Name</label>
                    <div className="flex items-center bg-gray-900 border border-gray-600 rounded-lg mt-1 px-3 focus-within:border-purple-500 transition-colors">
                      <span className="text-gray-500 select-none">#</span>
                      <input
                        autoFocus
                        className="w-full bg-transparent p-2.5 text-white focus:outline-none text-sm"
                        placeholder="general"
                        value={newChannelName}
                        onChange={e => setNewChannelName(e.target.value.toLowerCase().replace(/\s+/g, '-'))}
                      />
                    </div>
                  </div>
                  
                  <div className="flex justify-end gap-3 pt-2">
                    <button 
                      onClick={() => setShowNewChannelModal(false)} 
                      className="px-4 py-2 text-sm font-medium text-gray-300 hover:text-white hover:bg-gray-700 rounded-lg transition"
                    >
                      Cancel
                    </button>
                    <button 
                      onClick={createChannel} 
                      className="px-4 py-2 text-sm font-medium bg-purple-600 text-white rounded-lg hover:bg-purple-500 shadow-lg hover:shadow-purple-500/25 transition"
                    >
                      Create Channel
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}

        </div>
      );
    }

    // ================= INICIALIZACI√ìN REACT 18 =================
    const rootElement = document.getElementById('root');
    const root = ReactDOM.createRoot(rootElement);
    root.render(<App />);
  </script>
</body>
</html>
